<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>opam-provided (opam-monorepo.opam-provided)</title><link rel="stylesheet" href="../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> – <a href="index.html">opam-monorepo</a> &#x00BB; opam-provided</nav><header class="odoc-preamble"><h2 id="opam-provided-dependencies"><a href="#opam-provided-dependencies" class="anchor"></a><code>opam</code>-provided Dependencies</h2><p>This section documents a feature that’s useful when some dependencies cannot be installed via <code>opam-monorepo</code>. This workflow isn’t meant for regular use but only as a way to use <code>opam-monorepo</code> in cases where it wouldn't be otherwise possible.</p><p>We suggest minimizing its usage and prefer to use (and contribute) <code>dune-ports</code> from the <code>opam-overlays</code> repository. It's usage is safest with leaf-dependencies and those that don’t have dependency intersections with vendored packages. Due to possibly of unexpected interactions, this feature is only meant for advanced users, and the solutions it produces might be in flux.</p></header><nav class="odoc-toc"><ul><li><a href="#use-cases">Use Cases</a></li><li><a href="#initial-setup">Initial Setup</a></li><li><a href="#usage">Usage</a></li><li><a href="#how-it-works">How It Works</a><ul><li><a href="#resolution-of-dependency-overlaps">Resolution of Dependency Overlaps</a></li></ul></li></ul></nav><div class="odoc-content"><h3 id="use-cases"><a href="#use-cases" class="anchor"></a>Use Cases</h3><p>Sometimes it's not possible to put all your dependencies into the <code>duniverse</code>, be it due to your dependencies not building with <code>dune</code> or some tooling that should be just installed via <code>opam</code>. Such examples include:</p><ul><li>Packages not building with Dune</li><li>Packages that should not be vendored for legal reasons</li></ul><p>These users can opt-in to having some of their dependencies provided by <code>opam</code> instead of <code>opam-monorepo</code> pulling them into the <code>duniverse</code>.</p><h3 id="initial-setup"><a href="#initial-setup" class="anchor"></a>Initial Setup</h3><p>With the default configuration, <code>opam-monorepo</code> runs in full-<code>duniverse</code> mode, i.e., requiring all the dependencies of your opam files to be able to be built as part of the <code>duniverse</code>.</p><p>As such it's only recommended that packages are installed via <code>opam</code> for which there is no way to build them with <code>dune</code>, e.g., by using the <a href="https://github.com/dune-universe/opam-overlays">opam-overlays</a> repository with Dune ports.</p><p>To let <code>opam-monorepo</code> know a package is to be installed via <code>opam</code>, it needs to be marked as such in the opam file. For this, it needs to be added as normal in the <code>depends</code> field, as well in addition into the new <code>x-opam-monorepo-opam-provided</code> field. This field takes a single package or a list of packages to be installed via <code>opam</code> instead of being pulled into the <code>duniverse</code>.</p><p>To configure <code>opam-monorepo</code> to avoid pulling in package <code>foo</code>, specify it in the list of packages provided by opam:</p><pre class="language-ocaml"><code>depends: [
  &quot;foo&quot;
]
x-opam-monorepo-opam-provided: [&quot;foo&quot;]</code></pre><p>This can either be specified directly in the opam file or, if you use Dune to generate opam files, in the <code>.template</code> file. In such case, make sure to regenerate the opam file.</p><p>As a shortcut syntax, if there’s only one package, it’s possible to leave out the list and just specify the package itself:</p><pre class="language-ocaml"><code>depends: [
  &quot;foo&quot;
]
x-opam-monorepo-opam-provided: &quot;foo&quot;</code></pre><h3 id="usage"><a href="#usage" class="anchor"></a>Usage</h3><p>After you configured your opam file, you have to <em>lock</em> the environment.</p><pre class="language-ocaml"><code>$ opam monorepo lock</code></pre><p>After this succeeds, you will have an <code>.opam.locked</code> file containing all your project’s dependencies (including transitive dependencies). The ones that <code>opam-monorepo</code> will pull into the <code>duniverse</code> are marked as <code>vendor</code>.</p><pre class="language-ocaml"><code>$ opam install --ignore-pin-depends --deps-only ./ --locked
$ opam-monorepo pull</code></pre><h3 id="how-it-works"><a href="#how-it-works" class="anchor"></a>How It Works</h3><p>In addition to calculating the dependencies of the packages that will be included in the <code>duniverse</code>, <code>opam-monorepo</code> calculates the dependencies of the packages to be installed via <code>opam</code>. <code>opam-monorepo</code> then writes a lock file that sets a variable on all the dependencies it will pull, whereas <code>opam</code>-provided dependencies don't have variables set. In opam, unset variables are false; thus opam will ignore the packages that <code>opam-monorepo</code> will pull.</p><p>The <code>opam</code>-provided subset of dependencies is then <em>excluded</em> from the <code>duniverse</code> packages.</p><h4 id="resolution-of-dependency-overlaps"><a href="#resolution-of-dependency-overlaps" class="anchor"></a>Resolution of Dependency Overlaps</h4><p>There are cases where a dependency package appears multiple times in the project’s dependency tree. It’s possible that a package is part of the packages included in the <code>duniverse</code>, as well as packages installed by <code>opam</code>.</p><p>In such cases there are two possibilities:</p><ol><li>Install the package in <code>opam</code>, exclude it from duniverse</li><li>Install the package in <code>opam</code>, include a duplicate in the duniverse</li></ol><p>Both these approaches have advantages and disadvantages. <code>opam-monorepo</code> currently chooses #2 to maximize the amount of packages that are vendored, thus increasing the size of the reproducible set. Yet this doesn’t mean that two different versions of the package can be installed. The set of packages in opam and the <code>duniverse</code> must be co-installable!</p></div></body></html>
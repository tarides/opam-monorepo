<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>lock (opam-monorepo.lock)</title><link rel="stylesheet" href="../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> â€“ <a href="index.html">opam-monorepo</a> &#x00BB; lock</nav><header class="odoc-preamble"><h2 id="locking-dependencies"><a href="#locking-dependencies" class="anchor"></a>Locking dependencies</h2><p>One of the features of opam-monorepo is to generate lock files, containing a solution for the entire, transitive dependency tree of the project. This allows to ensure all devs working on it will use the exact same versions for each opam package dependency.</p><p>The <code>opam monorepo lock</code> command generates or updates lock files.</p></header><nav class="odoc-toc"><ul><li><a href="#updating-an-existing-lock-file">Updating an existing lock file</a></li><li><a href="#configuring-lock's-solver">Configuring <code>lock</code>'s solver</a><ul><li><a href="#opam-repositories">Opam Repositories</a></li><li><a href="#opam-global-variables">Opam Global Variables</a></li><li><a href="#opam-provided-packages">Opam provided packages</a></li></ul></li></ul></nav><div class="odoc-content"><h3 id="updating-an-existing-lock-file"><a href="#updating-an-existing-lock-file" class="anchor"></a>Updating an existing lock file</h3><p>By default, <code>opam monorepo lock</code> will generate a fresh lock file without taking into account any previous lock file you may have. In practice that means that it will likely update a lot of your dependencies, depending on upstream releases of course.</p><p>There are some scenarios where you might not want to update all of it but simply add a new dependency or update a single package to be able to use this brand new function they just released. You can run <code>opam monorepo lock --minimal-update</code> for this. Assuming there is a pre-existing lock file, it will generate a new version of it with minimum changes in the selected versions of your dependencies. It will prefer keeping versions from the previous lock file if possible. This mode is of course only useful if you run it after changing your dependency specification in one of your opam files as it will otherwise simply produce the same lock file.</p><h3 id="configuring-lock's-solver"><a href="#configuring-lock's-solver" class="anchor"></a>Configuring <code>lock</code>'s solver</h3><p>To generate a lock file, <code>opam-monorepo</code> first needs to find a solution that satisfies the project's dependencies and runs an opam solver based on <code>0install</code> for that.</p><p>There are certain aspects that can be configured either via the command line or in your opam files directly.</p><h4 id="opam-repositories"><a href="#opam-repositories" class="anchor"></a>Opam Repositories</h4><p>You can configure which repositories the solver will use to get the list of existing packages and their associated metadata.</p><p>By default it will use the repositories set in your current switch.</p><p>You can explicitly set the repositories to use, making <code>opam-monorepo</code> ignore the ones configured in the switch, along with in pins. You can do so by setting the <code>x-opam-monorepo-opam-repositories</code> extension in any of your local opam files. For instance:</p><pre class="language-ocaml"><code>x-opam-monorepo-opam-repositories: [
  &quot;git+https://github.com/ocaml/opam-repository&quot;
  &quot;git+https://github.com/dune-universe/opam-overlays&quot;
]</code></pre><p>Alternatively you can set it via the command line by running:</p><pre class="language-ocaml"><code>opam monorepo lock --opam-repositories \
  '[git+https://github.com/ocaml/opam-repository,git+https://github.com/dune-universe/opam-overlays]'</code></pre><p>The <code>--opam-repositories</code> option will overwrite any locally defined <code>x-opam-monorepo-opam-repositories</code> field. If you simply want to add extra repositories you can use <code>--add-opam-repositories</code> instead:</p><pre class="language-ocaml"><code>opam monorepo lock --add-opam-repositories '[git+https://me.com/my-repo]'</code></pre><p>When the field is set in multiple opam files and eventually through the <code>--add-opam-repositories</code> option, they are combined into a set, removing any duplicates. That set of URLs is what the solver will then use to get the available packages metadata in place of the ones set in the switch.</p><p>You can use any URL supported by opam, that includes local or remote git and tarball URLs as well as local folders.</p><p><b>IMPORTANT NOTE</b>: this feature is still in development and only local folders URLs are supported at the moment. Support for remote URLs will be available shortly! In the meantime you can set any repository in your switch, local or remote. As long as you don't set any repository explicitly via <code>opam-monorepo</code>'s options or opam extension, it will be able to use anything setup in the switch.</p><p>File system URLs cannot use relative paths. If you wish to use local folders for your repos, you can use the <code>$OPAM_MONOREPO_CWD</code> variable that will be replaced at runtime by <code>opam-monorepo</code>'s current working directory or the folder passed to <code>--root</code>. This will allow you to refer to repos defined within your workspace without writing path specific to your machine.</p><p>For instance if you have a repository defined in a <code>data/repo</code> sub folder of your project, you can get the solver to use it by setting:</p><pre class="language-ocaml"><code>x-opam-monorepo-opam-repositories: [
  &quot;file://$OPAM_MONOREPO_CWD/data/repo&quot;
]</code></pre><h4 id="opam-global-variables"><a href="#opam-global-variables" class="anchor"></a>Opam Global Variables</h4><p>You can set the value of opam global variables such as <code>arch</code> or <code>os-distribution</code>. These can have an impact on the solution picked by the solver as some package availability or dependencies vary based on their value.</p><p>By default <code>opam-monorepo</code> will use the variables set in your current switch.</p><p>You can explicitly set the variables defined along with their value, making <code>opam-monorepo</code> ignore any variable defined in the switch. You can do so by setting the <code>x-opam-monorepo-global-opam-vars</code> opam extension. For instance:</p><pre class="language-ocaml"><code>x-opam-monorepo-global-opam-vars: [
  [ &quot;arch&quot; &quot;x86_64&quot; ]
  [ &quot;os-distribution&quot; &quot;debian&quot; ]
  [ &quot;os-family&quot; &quot;debian&quot; ]
  [ &quot;os-version&quot; &quot;testing&quot; ]
]</code></pre><p>Alternatively you can set it via the command line by running:</p><pre class="language-ocaml"><code>opam monorepo lock \
  --opam-global-vars [[arch,x86_64],[os-distribution,debian],[os-family,debian],[os-version,testing]]</code></pre><p>The <code>--opam-global-vars</code> option will overwrite any locally defined <code>x-opam-monorepo-global-opam-vars</code> field. If you simply want to define extra variables you can use <code>--add-opam-global-vars</code> instead:</p><pre class="language-ocaml"><code>opam monorepo lock --add-global-vars [[some_var,some_value]]</code></pre><p>When the field is set in multiple opam files and eventually through the <code>--add-opam-global-vars</code> option, they are combined. A variable can appear multiple times as long as it is assigned the same value, it will error out otherwise.</p><p>The variables can be assigned boolean, string or list of strings values. The syntax for the opam field is the following:</p><pre class="language-ocaml"><code>x-opam-monorepo-global-opam-vars: [
  [&quot;boolean_var&quot; true]
  [&quot;string_var&quot; &quot;abc&quot;]
  [&quot;string_list_var&quot; [&quot;abc&quot; &quot;def&quot;]]
]</code></pre><p>The syntax for command line argument is the following:</p><pre class="language-ocaml"><code>--opam-global-vars [[boolean_var,true],[string_var,abc],[string_list_var,[abc,def]]]</code></pre><h4 id="opam-provided-packages"><a href="#opam-provided-packages" class="anchor"></a>Opam provided packages</h4><p>This feature has its own <a href="opam-provided.html">documentation page</a>.</p><p>You can define a set of packages that should be installed via opam rather than incorporated into the duniverse. This will influence how the solver treats those packages (they do not have to build with dune for instance).</p><p>By default all dependencies outside of <code>dune</code>, <code>ocaml</code> and a few other base packages are treated as if they were to be incorporated in the duniverse.</p><p>You can define which packages should be installed via opam by setting the <code>x-opam-monorepo-opam-provided</code> field in any of your local opam files. For instance:</p><pre class="language-ocaml"><code>x-opam-monorepo-opam-provided: [
  &quot;tezos-rust-libs&quot;
  &quot;ocamlfind&quot;
]</code></pre><p>Alternatively you can set it via the command line by running:</p><pre class="language-ocaml"><code>opam monorepo lock --opam-provided [tezos-rust-libs,ocamlfind]</code></pre><p>The <code>--opam-provided</code> option will overwrite any locally defined <code>x-opam-monorepo-opam-provided</code> field. If you simply want to define extra opam provided packages you can use <code>--add-opam-provided</code> instead:</p><pre class="language-ocaml"><code>opam monorepo lock --add-opam-provided [some-other-package]</code></pre><p>When the field is set in multiple opam files and eventually through the <code>--add-opam-provided</code> option, they are combinded into a set, removing duplicates.</p></div></body></html>
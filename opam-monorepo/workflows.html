<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>workflows (opam-monorepo.workflows)</title><link rel="stylesheet" href="../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> â€“ <a href="index.html">opam-monorepo</a> &#x00BB; workflows</nav><header class="odoc-preamble"><h2 id="workflows"><a href="#workflows" class="anchor"></a>Workflows</h2><p>This section documents day-to-day tasks in a project that uses <code>opam-monorepo</code>.</p></header><nav class="odoc-toc"><ul><li><a href="#initial-setup">Initial Setup</a></li><li><a href="#setting-up-continuous-integration">Setting Up Continuous Integration</a><ul><li><a href="#set-up-the-environment">Set Up the Environment</a></li><li><a href="#setup-the-workspace">Setup the Workspace</a></li><li><a href="#build-the-project">Build the Project</a></li><li><a href="#caching-strategies">Caching Strategies</a></li></ul></li><li><a href="#upgrading-all-dependencies">Upgrading All Dependencies</a></li><li><a href="#adding-a-dependency">Adding a Dependency</a></li></ul></nav><div class="odoc-content"><h3 id="initial-setup"><a href="#initial-setup" class="anchor"></a>Initial Setup</h3><p>There are several ways to configure a project to use <code>opam-monorepo</code>, depending on what is checked into Git.</p><ul><li><b>(Recommended)</b> <em>lockfile-in-git</em>: only check lock file into Git. Everybody gets a consistent view of the dependencies, but developers are responsible for running <code>opam monorepo pull</code>.</li><li><em>duniverse-in-git</em>: check lock file and <code>duniverse</code> folder into Git. This ensures that the repository is self-contained, but it can be very large.</li><li><em>not-locked</em>: Everybody is responsible for generating a lock file. Different people can end up with different dependencies. This is not really an <code>opam-monorepo</code> workflow, but it is a way <code>opam-monorepo</code> can be used to build a project even if it doesn't use <code>opam-monorepo</code>.</li></ul><p>As a summary:</p><ul><li><em>lockfile-in-git</em>: opam file and lock file checked in, <code>duniverse</code> ignored.</li><li><em>duniverse-in-git</em>: opam file, lock file and <code>duniverse</code> checked in.</li><li><em>not-locked</em>: opam file checked in, lock file and <code>duniverse</code> not checked in.</li></ul><p>We recommend using the <em>lockfile-in-git</em> workflow. To enable it, first generate a lock file (using <code>opam monorepo lock</code>), add it to your Git repository, together with <code>project.opam</code>, and add <code>duniverse/</code> in <code>.gitignore</code>.</p><p><em>Manage duniverse</em> explains in more depth how to best manage the files that <code>opam-monorepo</code> generates.</p><h3 id="setting-up-continuous-integration"><a href="#setting-up-continuous-integration" class="anchor"></a>Setting Up Continuous Integration</h3><p>Note: if you use <a href="https://ci.ocamllabs.io/">ocaml-ci</a>, you don't have anything to do. It will detect <code>opam-monorepo</code> builds and replace the opam-based builds by an <code>opam-monorepo</code> aware build that implements the rest of this section.</p><p>This section is useful if you want to implement a CI system based on <code>opam-monorepo</code>.</p><p>A build consists in three steps:</p><ol><li>Set up the environment</li><li>Set up the workspace</li><li>Build the project</li></ol><h4 id="set-up-the-environment"><a href="#set-up-the-environment" class="anchor"></a>Set Up the Environment</h4><p>In this context, &quot;the environment&quot; is a set of programs to be put in <code>$PATH</code>. An <code>opam-monorepo</code> build requires an OCaml compiler, Dune, and <code>opam-monorepo</code>. The project might require system packages (&quot;depexts&quot;) too. It's possible to rely on <code>opam</code> to install this environment, but it's not technically required.</p><p>The following assumes that opam is being used.</p><p>To set up the environment:</p><ul><li>It's only necessary to have access to the lock file (the opam file, <code>duniverse</code> folder, and source code are not used)</li><li>Create an opam switch compatible with the OCaml version mentioned in the lock file</li><li>Install Dune. The latest version usually works.</li><li>Install <code>opam-monorepo</code>. The version to pick depends the lock file format version (<code>x-opam-monorepo-version</code> field in the lock file). The rule is that a lock file with version <em>0.N</em> can be interpreted by <code>opam-monorepo</code> version <code>0.N.*</code>, but in most cases, <code>opam-monorepo</code> can read older versions. As <code>opam-monorepo</code> reaches version 1.0.0, more stability guarantees will exist.</li><li>Install depexts. Since format version 0.2, all depexts are recorded in the lock file, so they can be listed using <code>opam show -f depexts
  ./project.opam.locked</code>. In a future version, a command <code>opam monorepo depext</code> will provide a way to install them directly.</li></ul><h4 id="setup-the-workspace"><a href="#setup-the-workspace" class="anchor"></a>Setup the Workspace</h4><p>The next step is to set up a workspace that contains your project and its dependencies.</p><ul><li>This step requires access to the lock file and a way to download opam packages.</li><li>Run <code>opam monorepo pull</code>.</li></ul><h4 id="build-the-project"><a href="#build-the-project" class="anchor"></a>Build the Project</h4><p>In this step, the workspace is ready, so <code>dune build</code> commands can succeed. The exact command to run depends on the project, but for CI, <code>dune build</code> followed by <code>dune runtest</code> is usually the right thing to do (or in a single step, <code>dune
build @all @runtest</code>). If the goal of that pipeline is to produce release binaries, passing <code>--profile release</code> might be better. Consult the Dune documentation to know more about the difference.</p><h4 id="caching-strategies"><a href="#caching-strategies" class="anchor"></a>Caching Strategies</h4><p>This build skeleton can benefit from several caching strategies. The first one is to use a layering approach, e.g., by using Docker.</p><p>Most of the steps only require the lock file, so they can be cached and invalidated when the lock file changes.</p><p>For the OCaml compiler version, this can be a bit too conservative, as it will cause any change in the lock file to rebuild a switch. Instead, it's possible to hardcode the OCaml compiler version in the Docker file, and only check that the version is correct during the &quot;setup environment&quot; phase.</p><p>Doing only this will start all builds with an empty <code>_build</code> directory, so all dependencies need to be built each time. One solution to this is to persist the <code>_build</code> directory between builds. This can even be done across branches (the cache key is just the project name).</p><p>For local development, this means that <code>_build</code> is expensive to rebuild (similarly to a local opam switch). It is possible to set up a machine-global <a href="https://dune.readthedocs.io/en/stable/caching.html">dune cache</a> to speed up rebuilds.</p><h3 id="upgrading-all-dependencies"><a href="#upgrading-all-dependencies" class="anchor"></a>Upgrading All Dependencies</h3><p>To upgrade dependencies, run <code>opam monorepo lock</code>. It will compute a new solution based on the constraints in <code>project.opam</code> and the current state of <code>opam-repository</code>. Then locally run <code>opam monorepo pull</code> to update the <code>duniverse/</code> folder.</p><p>It's recommended to regularly create pull requests to update dependencies. When updating a local copy, developers will need to call <code>opam monorepo pull</code>.</p><h3 id="adding-a-dependency"><a href="#adding-a-dependency" class="anchor"></a>Adding a Dependency</h3><p>Note: this section also applies to all the cases where there are changes to the dependencies in <code>project.opam</code>, for example if a version constraint is modified.</p><p>To add a dependency:</p><ul><li>Add it to <code>project.opam</code> directly, or if you use opam file generation, add it to <code>dune-project</code> and run <code>dune build</code>.</li><li>Regenerate the lock file using <code>opam monorepo lock</code>.</li><li>Locally update the <code>duniverse/</code> folder using <code>opam monorepo pull</code>.</li><li>Open a PR with the changes to <code>project.opam</code>, the lock file, and optionally <code>dune-project</code>.</li></ul><p>This has the side effect of upgrading all dependencies too. To get a more conservative upgrade, one can do the upgrade in two steps:</p><ul><li>First, open a PR to update all dependencies as described above.</li><li>Then open a PR, adding a dependency. It will only contain changes relevant to that dependency.</li></ul></div></body></html>